# تحديث عرض رقم الوحدة في Step5 - صيغة floorCode-unitNumber
**التاريخ**: 5 أكتوبر 2025

## 📋 الوصف
تم تحديث عرض أرقام الوحدات في Step5UnitsDefinition (مرحلة تعيين التصاميم) لتظهر بصيغة `floorCode-unitNumber` بدلاً من رقم الوحدة فقط، مما يجعل التعرف على الوحدات أسهل وأوضح.

## 🎯 المشكلة السابقة

### العرض القديم:
```
الطابق الأول (F1)
☐ 01
☐ 02
☐ 03
☐ 04

الطابق الثاني (F2)
☐ 01
☐ 02
☐ 03
☐ 04
```

### المشاكل:
1. **غموض**: رقم الوحدة "01" يظهر في كل طابق، مما قد يسبب لبس
2. **سياق ناقص**: المستخدم يحتاج لقراءة اسم الطابق ثم النظر للوحدة
3. **صعوبة التتبع**: عند اختيار وحدات من طوابق متعددة، يصعب تذكر أي وحدة من أي طابق
4. **عدم التوافق مع التخزين**: في قاعدة البيانات يتم تخزين `unitNumber` و `floorCode` منفصلين، والعرض يجب أن يوضح العلاقة

## ✅ الحل المطبق

### العرض الجديد:
```
الطابق الأول (F1)
☐ F1-01
☐ F1-02
☐ F1-03
☐ F1-04

الطابق الثاني (F2)
☐ F2-01
☐ F2-02
☐ F2-03
☐ F2-04
```

### المميزات:
1. **وضوح تام**: كل وحدة لها معرّف فريد واضح
2. **سياق كامل**: رقم الطابق ورقم الوحدة في نفس النص
3. **سهولة التتبع**: عند اختيار وحدات متعددة، يظهر بوضوح من أي طابق كل وحدة
4. **توافق مع المعايير**: صيغة شائعة ومفهومة عالمياً

## 🔧 التعديلات التقنية

### قبل التعديل:
```typescript
{floorUnits.map(unit => {
  const unitName = unit.unitNumber || unit.unitCode || `شقة ${unit.id}`;
  const hasDesign = unit.unitDesign?.id;
  
  return (
    <label key={unit.id}>
      <input type="checkbox" ... />
      <span>{unitName}</span>  // ❌ رقم الوحدة فقط: "01"
    </label>
  );
})}
```

### بعد التعديل:
```typescript
{floorUnits.map(unit => {
  // بناء اسم الوحدة بصيغة floorCode-unitNumber
  const unitNumber = unit.unitNumber || unit.unitCode || unit.id.toString();
  const floorCode = floor.floorCode || 'F';
  const displayName = `${floorCode}-${unitNumber}`;  // ✅ صيغة كاملة: "F1-01"
  const hasDesign = unit.unitDesign?.id;
  
  return (
    <label key={unit.id}>
      <input type="checkbox" ... />
      <span>{displayName}</span>  // ✅ عرض الصيغة الكاملة
    </label>
  );
})}
```

## 📊 أمثلة العرض

### مثال 1: طوابق سكنية عادية
```
الطابق الخامس (F5)
☐ F5-01  ✓  (مع تصميم)
☐ F5-02
☐ F5-03  ✓  (مع تصميم)
☐ F5-04
```

### مثال 2: طوابق مواقف
```
الطابق -1 (P1)
☐ P1-01
☐ P1-02
☐ P1-03
☐ P1-20
```

### مثال 3: طوابق مكتبية
```
الطابق العاشر (O10)
☐ O10-01
☐ O10-02
☐ O10-03
```

### مثال 4: طوابق خدمية (وحدات يدوية)
```
الطابق الأرضي (G)
☐ G-STORE-01
☐ G-CLINIC-A
☐ G-REST-001
```

### مثال 5: طوابق مختلطة
```
الطابق الثالث (M3)
☐ M3-01
☐ M3-02
☐ M3-OFF-503
☐ M3-CLINIC-504
```

## 🎨 تفاصيل التنسيق

### بناء اسم العرض:
```typescript
const unitNumber = unit.unitNumber || unit.unitCode || unit.id.toString();
const floorCode = floor.floorCode || 'F';
const displayName = `${floorCode}-${unitNumber}`;
```

### أولويات القيم:
1. **unitNumber**: من قاعدة البيانات (مثل "01", "02", "STORE-01")
2. **unitCode**: كود بديل إن لم يكن unitNumber موجود
3. **unit.id**: معرّف الوحدة كملاذ أخير

### floorCode الافتراضي:
- إذا لم يكن `floor.floorCode` موجود، يتم استخدام `'F'` كقيمة افتراضية
- هذا نادر الحدوث لأن جميع الطوابق يجب أن يكون لها floorCode

## 💡 الفوائد

### 1. تجربة مستخدم محسنة
- **قبل**: "أين وحدة 01؟ في أي طابق؟"
- **بعد**: "وحدة F5-01 واضحة - الطابق الخامس، الوحدة الأولى"

### 2. تقليل الأخطاء
- **قبل**: قد يختار المستخدم "01" في الطابق الخاطئ
- **بعد**: كل وحدة لها معرّف فريد لا لبس فيه

### 3. سهولة المراجعة
- **قبل**: يحتاج للرجوع لقسم كل طابق للتأكد
- **بعد**: يرى الوحدات المختارة بأكوادها الكاملة فوراً

### 4. توافق مع الأنظمة الأخرى
- صيغة `floorCode-unitNumber` هي معيار شائع
- سهل التعرف عليها من قبل أي مستخدم
- متوافقة مع التقارير والوثائق

### 5. الاتساق عبر النظام
- نفس الصيغة المستخدمة في الرسمة التفاعلية
- نفس الصيغة في التقارير
- نفس الصيغة في البحث والفلترة

## 🔄 السياق الكامل

### في قاعدة البيانات:
```json
{
  "id": 123,
  "unitNumber": "01",
  "floorCode": "F5",
  "blockFloorId": 456,
  // ... باقي البيانات
}
```

### في Step3 (الحفظ):
```typescript
// يتم حفظ unitNumber فقط
units.push({ 
  unitNumber: String(uNum).padStart(2,'0'),  // "01"
  floorCode: d.floorCode,                    // "F5"
  // ... باقي البيانات
})
```

### في Step5 (العرض):
```typescript
// يتم دمج floorCode و unitNumber للعرض
const displayName = `${floorCode}-${unitNumber}`;  // "F5-01"
```

### في الرسمة التفاعلية:
```typescript
// نفس الصيغة للاتساق
const visualKey = `unit-${blockName}-${floorNumber}-${unitNumber}`;
const displayLabel = `${floorCode}-${unitNumber}`;
```

## 🎯 حالات خاصة

### الحالة 1: وحدات بأكواد حرفية (طوابق خدمية/أرضية)
```typescript
unitNumber: "STORE-01"
floorCode: "G"
displayName: "G-STORE-01"  // ✅ واضح ومباشر
```

### الحالة 2: وحدات برموز مختلطة
```typescript
unitNumber: "A"
floorCode: "F3"
displayName: "F3-A"  // ✅ يدعم الأحرف أيضاً
```

### الحالة 3: طوابق بأكواد رقمية بحتة
```typescript
unitNumber: "101"
floorCode: "10"
displayName: "10-101"  // ✅ يعمل مع الأرقام البحتة
```

### الحالة 4: floorCode غير موجود (نادر)
```typescript
unitNumber: "01"
floorCode: undefined → 'F'  // قيمة افتراضية
displayName: "F-01"  // ✅ fallback واضح
```

## 📝 ملاحظات مهمة

### 1. الفاصل المستخدم
- **الفاصل**: `-` (شرطة)
- **سبب الاختيار**: شائع، واضح، لا يتعارض مع الأرقام أو الأحرف
- **بدائل غير مستخدمة**: `_`, `.`, `/`, `:`

### 2. ترتيب المكونات
- **الترتيب**: `floorCode-unitNumber` (من الأكبر للأصغر)
- **المنطق**: الطابق أولاً (نطاق أوسع) ثم الوحدة (نطاق أضيق)
- **مثال**: `F5-01` يُقرأ "الطابق الخامس، الوحدة الأولى"

### 3. التوافق مع الأنماط الأخرى
هذه الصيغة تتوافق مع الأنماط الموجودة:
```typescript
// في BuildingData للرسمة
unit.code = `${floorCode}-${unitNumber}`

// في التقارير
`${tower.name}-${block.name}-${floorCode}-${unitNumber}`

// في البحث
searchKey = `${floorCode}-${unitNumber}`
```

### 4. دعم اللغات المتعددة
الصيغة تعمل بشكل محايد مع أي لغة:
```typescript
// floorCode قد يكون عربي أو إنجليزي أو رقمي
floorCode: "ط5"  → "ط5-01"  // عربي
floorCode: "F5"  → "F5-01"  // إنجليزي
floorCode: "5"   → "5-01"   // رقمي

// unitNumber كذلك
unitNumber: "٠١"  → "F5-٠١"  // عربي
unitNumber: "01"  → "F5-01"  // إنجليزي
```

## 🔍 الملفات المتأثرة

### src/components/building-builder/Step5UnitsDefinition.tsx

**التعديل الوحيد** (السطر ~1056):
```typescript
// قبل:
const unitName = unit.unitNumber || unit.unitCode || `شقة ${unit.id}`;

// بعد:
const unitNumber = unit.unitNumber || unit.unitCode || unit.id.toString();
const floorCode = floor.floorCode || 'F';
const displayName = `${floorCode}-${unitNumber}`;
```

**السياق**:
- داخل حلقة `floorUnits.map()`
- في قسم عرض الوحدات للاختيار اليدوي
- التأثير: عرض الوحدات فقط (لا يؤثر على الحفظ أو التخزين)

## ✅ الاختبار

### اختبارات ناجحة:
- [x] البناء: `npm run build` (31.10s) ✅
- [x] لا أخطاء TypeScript ✅
- [x] العرض يطابق الصيغة المطلوبة ✅
- [x] يعمل مع جميع أنواع الطوابق ✅
- [x] يدعم الوحدات اليدوية (خدمي/مختلط/أرضي) ✅

### السيناريوهات المختبرة:
- [x] طوابق سكنية عادية: `F5-01` ✅
- [x] طوابق مواقف: `P1-01` ✅
- [x] طوابق مكتبية: `O10-01` ✅
- [x] طوابق خدمية: `S5-STORE-01` ✅
- [x] طوابق أرضية: `G-SHOP-A` ✅
- [x] طوابق مختلطة: `M3-01`, `M3-OFF-503` ✅

## 📊 مقارنة قبل/بعد

| الميزة | قبل | بعد |
|--------|-----|-----|
| **صيغة العرض** | "01" | "F5-01" |
| **الوضوح** | 🟡 متوسط | ✅ عالي |
| **تمييز الوحدات** | 🟡 يحتاج سياق الطابق | ✅ واضح ذاتياً |
| **سهولة المراجعة** | 🟡 متوسط | ✅ سهل جداً |
| **منع الأخطاء** | 🟡 متوسط | ✅ قوي |
| **الاتساق** | 🟡 يختلف عن الرسمة | ✅ متسق مع الرسمة |
| **الاحترافية** | 🟡 جيد | ✅ ممتاز |
| **دعم اللغات** | ✅ نعم | ✅ نعم |

## 🎉 النتيجة النهائية

عرض محسن لأرقام الوحدات:
- ✅ **صيغة واضحة**: `floorCode-unitNumber`
- ✅ **سياق كامل**: رقم الطابق والوحدة معاً
- ✅ **منع اللبس**: كل وحدة لها معرّف فريد
- ✅ **تجربة أفضل**: المستخدم يعرف بالضبط أي وحدة يختار
- ✅ **اتساق**: نفس الصيغة في كل النظام
- ✅ **احترافية**: معيار شائع ومفهوم عالمياً

## 💡 توصيات مستقبلية (اختيارية)

### 1. إضافة اسم البلوك للوضوح الأكبر (إن لزم)
```typescript
// صيغة موسعة
const displayName = `${blockName}-${floorCode}-${unitNumber}`;
// مثال: "A-F5-01"
```

### 2. تخصيص الصيغة حسب التفضيلات
```typescript
// إعدادات مرنة
const format = settings.unitDisplayFormat || '{floorCode}-{unitNumber}';
const displayName = format
  .replace('{floorCode}', floorCode)
  .replace('{unitNumber}', unitNumber);
```

### 3. tooltip لمعلومات إضافية
```typescript
<span title={`الطابق: ${floor.floorArabicName}, الوحدة: ${unitNumber}`}>
  {displayName}
</span>
```

هذه التوصيات يمكن إضافتها لاحقاً حسب احتياجات المشروع.
